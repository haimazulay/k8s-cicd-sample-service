name: "L1 - PR Build & Helm Package"

on:
  pull_request:
    branches:
      - main
      - develop
    # Optional: ignore changes that are not relevant to the build
    paths-ignore:
      - "README.md"
      - ".github/**"

env:
  # Image name defaults to the repository full name (org/repo)
  IMAGE_NAME: ${{ github.repository }}
  # Path to the Dockerfile (can be overridden per repo if needed)
  DOCKERFILE_PATH: ./Dockerfile
  # Path to the Helm chart within the target repository
  HELM_CHART_DIR: ./helm/app-chart

jobs:
  build-and-package:
    name: "Build image and package Helm chart"
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: "Checkout source code"
        uses: actions/checkout@v4
        # This will checkout the target repository code when copied there.

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3
        # Buildx is recommended for modern Docker builds and caching.

      - name: "Docker login (optional, based on secrets)"
        id: docker_login
        run: |
          if [ -z "${DOCKERHUB_USERNAME}" ] || [ -z "${DOCKERHUB_TOKEN}" ]; then
            echo "Docker Hub credentials are not configured. Skipping registry login."
            echo "push_image=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Logging in to Docker Hub as ${DOCKERHUB_USERNAME}..."
          echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
          echo "push_image=true" >> "$GITHUB_OUTPUT"
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        # This step:
        #  - checks if credentials exist
        #  - logs in only when both username and token are provided
        #  - exposes an output 'push_image' that controls whether we push the image

      - name: "Build and optionally push Docker image"
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: ${{ steps.docker_login.outputs.push_image == 'true' }}
          tags: |
            ${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}
            ${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
        # When 'push_image' is true, the image will be pushed to Docker Hub.
        # Otherwise, this runs as a pure build validation without pushing.

      - name: "Install Helm CLI"
        uses: azure/setup-helm@v4
        with:
          version: v3.16.2
        # Installing a specific Helm version improves reproducibility across runs.

      - name: "Lint Helm chart"
        run: |
          echo "Linting Helm chart in directory: ${HELM_CHART_DIR}"
          helm lint "${HELM_CHART_DIR}"
        env:
          HELM_CHART_DIR: ${{ env.HELM_CHART_DIR }}
        # 'helm lint' validates chart structure and values for common issues.

      - name: "Package Helm chart"
        run: |
          mkdir -p packaged-chart
          echo "Packaging Helm chart from: ${HELM_CHART_DIR}"
          helm package "${HELM_CHART_DIR}" --destination packaged-chart
        env:
          HELM_CHART_DIR: ${{ env.HELM_CHART_DIR }}
        # 'helm package' creates a versioned .tgz that can be used for deployments.

      - name: "Upload packaged chart as workflow artifact"
        uses: actions/upload-artifact@v4
        with:
          name: helm-chart-pr-${{ github.event.pull_request.number }}
          path: packaged-chart/*.tgz
        # The packaged Helm chart is attached to the PR run, so it can be
        # downloaded and inspected without accessing any registry.
