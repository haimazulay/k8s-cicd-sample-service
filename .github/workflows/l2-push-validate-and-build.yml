name: "L2 - Push Validate & Build"

on:
  push:
    branches:
      - main
      - develop
      - "feature/**"
      - "hotfix/**"
    paths-ignore:
      - "README.md"
      - ".github/**"

env:
  # Default image name is the GitHub repository full name (org/repo).
  IMAGE_NAME: ${{ github.repository }}

  # Default path to the Dockerfile. Can be customized per onboarded repo.
  DOCKERFILE_PATH: ./Dockerfile

  # Default container registry. For Docker Hub this is docker.io.
  REGISTRY: docker.io

jobs:
  validate-and-build:
    name: "Run validations and build Docker image"
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: "Checkout source code"
        uses: actions/checkout@v4
        # This checks out the application repository that uses this workflow.

      - name: "Application validations (placeholder)"
        run: |
          echo "No validation command is configured yet."
          echo "Update this step to run your application tests and linters."
          echo "Examples:"
          echo "  - pytest"
          echo "  - npm test"
          echo "  - golangci-lint run"
        # Each onboarded repository can replace this with real tests.

      - name: "Set up Docker Buildx"
        uses: docker/setup-buildx-action@v3
        # Buildx enables advanced Docker build features and better caching.

      - name: "Docker login (optional, based on secrets)"
        id: docker_login
        run: |
          if [ -z "${DOCKERHUB_USERNAME}" ] || [ -z "${DOCKERHUB_TOKEN}" ]; then
            echo "Docker Hub credentials are not configured. Skipping registry login."
            echo "push_image=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Logging in to Docker Hub as ${DOCKERHUB_USERNAME}..."
          echo "${DOCKERHUB_TOKEN}" | docker login -u "${DOCKERHUB_USERNAME}" --password-stdin
          echo "push_image=true" >> "$GITHUB_OUTPUT"
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        # This step decides if we will push the image or just build it locally.

      - name: "Build and optionally push Docker image"
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE_PATH }}
          push: ${{ steps.docker_login.outputs.push_image == 'true' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:branch-${{ github.ref_name }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:sha-${{ github.sha }}
        # If 'push_image' is true, the image will be pushed to Docker Hub.
        # Otherwise, this acts as a validation-only build.
        #
        # Tags include both the branch name and the commit SHA so it is easy
        # to trace which commit produced which image.
